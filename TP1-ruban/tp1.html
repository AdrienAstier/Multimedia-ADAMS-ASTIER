<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>TP1</title>
  <!-- voir https://greensock.com/docs/v3/Installation#installer -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
</head>
<body>

    <div style="margin: 10px;">
        <button onclick="led2.reset()">Reset</button>
        <button onclick="led2.anim1()">Animation 1</button>
        <button onclick="led2.anim2()">Animation 2</button>
        <button onclick="led2.anim3()">Animation 3</button>
        <button onclick="anim4()">Animation 4</button>
    </div>

  <!-- dessin SVG créé et modifié par les scripts JS -->
  <svg xmlns="http://www.w3.org/2000/svg"
        width="100%" viewBox="0 0 200 200"
        id="dessin">
  </svg>

  <!-- utilisation du mixin SVGelement -->
  <script src="svgelement.js"></script>

  <script>
// compléments à la librairie Math
Math.radians = (deg) => deg * Math.PI / 180
Math.degrees = (rad) => rad / Math.PI * 180
    

    class Led {
        constructor(parent, x, y, radius) {
            this.led = parent.appendElement("circle", {
                cx: x,
                cy: y,
                r: radius - radius/16,
                fill: "gray",
                stroke: "black",
                'stroke-width': radius/8
            });
            this._state = 0;
        }

        get state() { return this._state; }
        set state(v) {
            const value = Math.max(0, Math.min(1, +v || 0));
            this._state = value;
            const color = gsap.utils.interpolate("gray", "rgb(255,0,0)", value);
            this.led.setAttribute("fill", color);
        }

        turnOn(timeline, duration = 0.1, position = ">") {
            timeline.to(this.led, { attr: { fill: "red" }, duration }, position);
        }
        turnOff(timeline, duration = 0.1, position = ">") {
            timeline.to(this.led, { attr: { fill: "gray" }, duration }, position);
        }

        reset() {
            this.state = 0;
            gsap.killTweensOf(this);
        }

        anim1() {
            const tl = gsap.timeline();
            this.turnOn(tl, 1.0);
            this.turnOff(tl, 0.5, ">+1.5");
        }
        anim2() {
            const tl = gsap.timeline();
            tl.to(this, { state: 1, duration: 1.0 });
            tl.to(this, { state: 0, duration: 0.5 }, ">+2");
        }
        anim3() {
            const tl = gsap.timeline();
            this.turnOn(tl, 0.7);
            this.turnOff(tl, 0.4, ">+0.8");
            tl.to(this, { state: 1, duration: 0.5 }, ">+0.5");
            tl.to(this, { state: 0, duration: 0.4 }, ">+0.8");
        }
    }

    class LedRibbon {
        constructor(parent, generator) {
            this.parent = parent;
            this.leds = [];
            for (const {x, y, radius} of generator) {
                this.leds.push(new Led(parent, x, y, radius));
            }
        }
        reset() { for (const led of this.leds) led.reset(); }
        turnOnOff(tl, durationOn = 0.2) {
            const tOn = 0.05, tOff = 0.05;
            for (const led of this.leds) {
                tl.to(led, { state: 1, duration: tOn }, ">");
                tl.to(led, { state: 0, duration: tOff }, `>+${durationOn}`);
            }
        }
    }

    const svg = SVGelement.fromSelector("#dessin");

    //const led2 = new Led(svg, 70, 40, 10);
    // const ribbon = new LedRibbon(svg, SpiralV1({
    //     number: 48, // nombre de leds
    //     cx: 120, cy: 50, // centre de la spirale
    //     turns: 3, // nombre de tours
    //     pitch: 12 // écart entre les spires
    // }));
    const ribbon = new LedRibbon(svg, SpiralV2({
        number: 44, // nombre de leds
        cx: 120, cy: 50, // centre de la spirale
        pitch: 12, // écart entre les spires
        spacing: 7, // écart entre les leds
    }))
    

    function anim4() {
        const TLrib = gsap.timeline()
        ribbon.turnOnOff(TLrib, 0.2)
    }

    function* HorizontalLine({ number, x, y, spacing = 0, radius = 4 } = {}) {
        const interval = radius * 2 + spacing;
        for (let i = 0; i < number; i++) {
            yield { x: x + i * interval, y, radius };
        }
    }

    function* PolarLine({ number, x, y, angle, spacing = 0, radius = 4 } = {}) {
        const interval = radius * 2 + spacing;
        const rad = Math.radians(angle);
        const dx = interval * Math.cos(rad);
        const dy = interval * Math.sin(rad);
        let cx = x, cy = y;
        for (let i = 0; i < number; i++) {
            yield { x: cx, y: cy, radius };
            cx += dx; cy += dy;
        }
    }

    function* Circle({ number, cx, cy, r, radius = 4 } = {}) {
        for (let i = 0; i < number; i++) {
            const angle = 2 * Math.PI * i / number;
            const x = cx + r * Math.cos(angle);
            const y = cy + r * Math.sin(angle);
            yield { x, y, radius };
        }
    }

    function* SpiralV1({ number, cx, cy, turns, pitch, radius = 4 } = {}) {
        for (let i = 0; i < number; i++) {
            const t = i / (number - 1 || 1);
            const angle = turns * 2 * Math.PI * t;
            const r = turns * pitch * t;
            const x = cx + r * Math.cos(angle);
            const y = cy + r * Math.sin(angle);
            yield { x, y, radius };
        }
    }

    function* SpiralV2({ number, cx, cy, pitch, spacing, radius = 4 } = {}) {
        let angle = 0;
        for (let i = 0; i < number; i++) {
            angle = Math.sqrt((2 * spacing * spacing) / pitch + angle * angle);
            const r = (pitch * angle) / (2 * Math.PI);
            const x = cx + r * Math.cos(angle);
            const y = cy + r * Math.sin(angle);
            yield { x, y, radius };
        }
    }


  </script>
</body>
</html>
